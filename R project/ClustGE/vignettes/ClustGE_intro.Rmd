---
title: "A brief introduction to ClustGE"
name: "Giulia Di Virgilio"
email: giulia.divirgilio@mail.polimi.it
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: > 
 %\VignetteIndexEntry{ClustGE Intro}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
knitr:
  opts_chunk:
    message: false
    warning: false
---
`ClustGE` is an R package designed to analyze gene expression data and cluster genes based on their expression profiles. 
It provides tools to:
- read imported gene expression data and preprocess it (i.e. normalization and outlier detection)
- perform exploratory analyses
- apply clustering algorithms (Hierarchical, k-means, graph-based, etc.)
- visualize gene clusters through the use of heatmaps, PCA plots and dendrograms
- perform enrichment analysis (GO, KEGG)

This vignette provides a step-by-step introduction to the package.
```{r setup, message=FALSE, warning=FALSE}
library(ClustGE)
library(SummarizedExperiment)
```


# Reading expression data
The read_expression() function takes in gene expression data as input and always returns either a SummarizedExperiment or an ExpressionSet object.
Accepted input:
* `CSV file`
* `ExpressionSet` (from Biobase)
* `SummarizedExperiment` (from SummarizedExperiment)

Example using a CSV file:
```{r reading expression}
library(ClustGE)
se <- read_expression(file = system.file("extdata", "gene_expr_example.csv", package = "ClustGE"))
```

# Data exploration and plots
Before applying normalization, it is useful to explore how expression values are distributed. 
`ClustGE` provides two visualization functions:

- `plot_expression_distribution()`: histogram of all expression values.  
- `plot_sample_boxplot()`: per-sample boxplots. 

```{r plots}
plot_expression_distribution(se)
plot_sample_boxplot(se)
```

These two functions can be used after normalization as well.

# Preprocessing
### Normalization
Normalization is an essential step in the preprocessing of gene expression data in order to make samples comparable.
The normalize_expr() function applies common normalization techniques and always returns the input object (a SummarizedExperiment or ExpressionSet).

Possible normalization techniques:
* log2 normalization
* quantile normalization
Z-scoring is also possible.

Here is an example with log2 normalization with z-scoring:
```{r normalization}
library(SummarizedExperiment)
se_norm <- normalize_expr(se, method = "log", standardize = FALSE)
assay(se_norm, "counts")
plot_sample_boxplot(se_norm)
```

### Removing outlier genes
Some genes may have extreme mean expression values compared to the majority of the genes.
The remove_outlier_genes() identifies these outliers using the IQR rule and flags or removes them.
```{r outliers}
se_clean <- remove_outlier_genes(se_norm, assay_name = "counts", remove = TRUE)
```

# Clustering
Once the data has been normalized and cleaned, it is time to move onto clustering.
`ClustGE` provides multiple clustering algorithms:
* `Hierarchical clustering`: hierarchical_clust() builds dendrograms to visualize nested clusters;
* `K-means clustering`: kmeans_clust() partitions data points into k groups;
* `Graph-based clustering`: graph_based_clust() uses nearest-neighbor graphs and Louvain community detection (commonly used for gene expression data).
Clusters can also be annotated by setting "annotate = TRUE".

Here is one example using kmeans clustering:
```{r kmeans annotated}
km <- kmeans_clust(se_norm, centers = 5, target = "genes", annotate = TRUE)
```

```{r kmeans}
km <- kmeans_clust(se_norm, centers = 5, target = "genes", annotate = FALSE)
```

## Visualization of clustering results
Once genes or samples have been clustered, visualization is essential to interpret the results.
This package provides three main plotting utilities:
* Heatmaps with cluster annotation
* PCA plot of samples
* Dendrograms

The plot_clustered_heatmaps() function produces a heatmap of the expression matrix, with rows or columns annotated by cluster assignments. Here is an example using annotated hierarchical clustering.
```{r hclustering}
hc_annot <- hierarchical_clust(se_clean, target = "genes", annotate = TRUE, k = 4)
plot_clustered_heatmap(hc_annot$object, target = "genes", cluster_col = "Cluster")
```

The plot_pca() function reduces the high-dimensional expression matrix to the first two principal components (PC1 and PC2) and visualizes samples in 2D space. Metadata variables can be used to color the samples.
```{r pca}
hc_annot <- hierarchical_clust(se_clean, target = "samples", annotate = TRUE, k = 3)
plot_pca(hc_annot$object, color_by = "Cluster")
```

The plot_dendrogram() function takes an hclust object and plots the tree structure. If k is provided, branches are colored according to the cluster cut.
```{r dendrograms}
hc_annot <- hierarchical_clust(se_clean, target = "samples", annotate = TRUE, k = 3)
mat <- SummarizedExperiment::assay(hc_annot$object, "counts")
hc <- hclust(dist(t(mat)))
plot_dendrogram(hc, k = 3)
```

# Functional enrichment analysis of gene clusters
Once gene clusters have been identified, it is important to check whether they are enriched for particular biological processes, pathways, or functions. 
This package provides wrappers around clusterProfiler for Gene Ontology (GO) and KEGG pathway enrichment.

### Extracting genes per cluster
The function get_genes_by_cluster() extracts the set of genes belonging to each cluster from a SummarizedExperiment or ExpressionSet:
```{r clusters&genes}
hc_annot <- hierarchical_clust(se_clean, target = "genes", annotate = TRUE, k = 4)
genes_by_cluster <- get_genes_by_cluster(hc_annot$object, target = "genes")
```

### GO enrichment analysis
The perform_cluster_go_enrichment() is used to test for Gene Ontology enrichment. This requires an OrgDb annotation package (e.g. org.Hs.eg.db for human).
```{r GO, message=FALSE, warning=FALSE}
library(org.Hs.eg.db)
go_results <- perform_cluster_go_enrichment(
  genes_by_cluster,
  orgdb = org.Hs.eg.db,
  ont = "BP"
)
plot_cluster_go_enrichment(go_results, n = 10)
```

### KEGG pathway enrichment
Alternatively, the perform_enrichKEGG() function tests for KEGG pathway enrichment, directly using the clustered object.
```{r KEGG, message=FALSE, warning=FALSE}
kegg_results <- perform_enrichKEGG(
  se_clean,
  target = "genes",
  organism = "hsa", # human
  keyType = "ncbi-geneid"
)
```

### Session Info

```{r session-info}
sessionInfo()
```
